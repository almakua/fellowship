---
# =============================================================================
# Playbook: Deploy NFS Server
# =============================================================================
# Configura il server NFS su aragorn per storage persistente k3s
# =============================================================================

- name: Deploy NFS Server
  hosts: nfs_servers
  gather_facts: true
  become: true

  tasks:
    # =========================================================================
    # Installazione NFS Server
    # =========================================================================
    - name: Install NFS server packages
      ansible.builtin.apt:
        name:
          - nfs-kernel-server
          - nfs-common
        state: present
        update_cache: true

    # =========================================================================
    # Creazione directory export
    # =========================================================================
    - name: Create NFS export directory
      ansible.builtin.file:
        path: "{{ nfs_export_path }}"
        state: directory
        owner: nobody
        group: nogroup
        mode: '0777'

    # =========================================================================
    # Configurazione exports
    # =========================================================================
    - name: Configure NFS exports
      ansible.builtin.lineinfile:
        path: /etc/exports
        regexp: "^{{ nfs_export_path }}"
        line: "{{ nfs_export_path }} 192.168.1.0/24({{ nfs_export_options }})"
        state: present
      notify: Reload NFS exports

    # =========================================================================
    # Avvio servizi
    # =========================================================================
    - name: Enable and start NFS server
      ansible.builtin.systemd:
        name: nfs-kernel-server
        enabled: true
        state: started

  handlers:
    - name: Reload NFS exports
      ansible.builtin.command: exportfs -ra
      changed_when: true

# =============================================================================
# Verifica connettivitÃ  NFS dai worker
# =============================================================================
- name: Verify NFS connectivity from workers
  hosts: k3s_workers
  gather_facts: false
  become: true

  tasks:
    - name: Test NFS mount
      ansible.builtin.command: >
        showmount -e {{ nfs_server_ip }}
      register: showmount_result
      changed_when: false
      failed_when: false

    - name: Display NFS exports
      ansible.builtin.debug:
        msg: "{{ showmount_result.stdout_lines }}"
      when: showmount_result.rc == 0

    - name: Warn if NFS not accessible
      ansible.builtin.debug:
        msg: "WARNING: NFS server not accessible from {{ inventory_hostname }}"
      when: showmount_result.rc != 0

